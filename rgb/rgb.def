Bootstrap: localimage
From: rgb-base.sif

%arguments
    SIMD=avx

%post
    cd /opt

    cd geant4-build
    mkdir build
    cd build
    cmake -G Ninja ../src/ -DCMAKE_INSTALL_PREFIX=/opt/geant4 -DCMAKE_BUILD_TYPE=release -DCMAKE_C_STANDARD=17 -DCMAKE_CXX_STANDARD=20 -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_FLAGS="-m{{SIMD}}" -DCMAKE_CXX_FLAGS="-m{{SIMD}}" -DGEANT4_BUILD_MULTITHREADED=OFF -DGEANT4_INSTALL_DATA=ON -DGEANT4_INSTALL_DATADIR=/opt/geant4-data -DGEANT4_INSTALL_PACKAGE_CACHE=OFF -DGEANT4_INSTALL_DATASETS_TENDL=ON -DGEANT4_USE_GDML=ON -DGEANT4_USE_OPENGL_X11=ON -DGEANT4_USE_QT=ON -DGEANT4_USE_RAYTRACER_X11=ON -DGEANT4_USE_SYSTEM_ZLIB=ON -DBUILD_SHARED_LIBS=ON -DBUILD_STATIC_LIBS=OFF -DGEANT4_BUILD_BUILTIN_BACKTRACE=OFF
    cd ../..

    cd root-build
    mkdir build
    cd build
    cmake -G Ninja ../src/ -DCMAKE_INSTALL_PREFIX=/opt/root -DCMAKE_BUILD_TYPE=release -DCMAKE_C_STANDARD=17 -DCMAKE_CXX_STANDARD=20 -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_FLAGS="-m{{SIMD}}" -DCMAKE_CXX_FLAGS="-m{{SIMD}}"
    cd ../..

    cd geant4-build/build
    ninja &
    cd ../../root-build/build
    ninja
    cd ../..
    wait

    cd geant4-build/build
    ninja install
    cd ../../root-build/build
    ninja install
    cd ../..

    rm -rf geant4-build &
    rm -rf root-build
    wait

%environment
    export LC_ALL=C
    export PATH=/opt/root/bin:/opt/geant4/bin:${PATH}
    export LIBRARY_PATH=/opt/root/lib:/opt/geant4/lib:${LIBRARY_PATH}
    export LD_LIBRARY_PATH=/opt/root/lib:/opt/geant4/lib:${LD_LIBRARY_PATH}
    export MANPATH=/opt/root/man
    export CMAKE_PREFIX_PATH=/opt/root:/opt/geant4:${CMAKE_PREFIX_PATH}
    export GEANT4_DATA_DIR=/opt/geant4-data
    export ROOTSYS=/opt/root
    export CLING_STANDARD_PCH=none

%labels
    Author zhaoshihan
    SIMD {{SIMD}}
